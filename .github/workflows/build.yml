name: Build CGCT bundle (Nuitka OneFile + Cache)

on:
  push:
    branches: [ main, master ]
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: ${{ matrix.target.name }}
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: windows-x64
            os: windows-latest
            python: "3.11"
            executable_name: CGCT.exe
            mauve_asset: progressiveMauve-v2.5.0-windows-x64.zip
            mauve_bin: progressiveMauve.exe
            readme_src: README_WINDOWS.md
            include_extras: "true" # Controls config.txt and Dockerfile

          - name: linux-x64
            os: ubuntu-24.04
            python: "3.11"
            executable_name: CGCT.bin
            mauve_asset: progressiveMauve-v2.5.0-linux-x86_64.tar.gz
            mauve_bin: progressiveMauve
            readme_src: README_LINUX_AMD64.md
            include_extras: "false"

          - name: macos-x64
            os: macos-15-intel
            python: "3.11"
            executable_name: CGCT.bin
            mauve_asset: progressiveMauve-v2.5.0-macos-intel.tar.gz
            mauve_bin: progressiveMauve
            readme_src: README_MAC_AMD64.md
            include_extras: "true"

          - name: macos-arm64
            os: macos-14
            python: "3.11"
            executable_name: CGCT.bin
            mauve_asset: progressiveMauve-v2.5.0-macos-arm64.tar.gz
            mauve_bin: progressiveMauve
            readme_src: README_MAC_ARM64.md
            include_extras: "true"

    runs-on: ${{ matrix.target.os }}

    env:
      APP_NAME: CGCT
      ENTRYPOINT: CGCT.py
      MAUVE_REPO: unlistedhybrid/progressiveMauve-modernization
      MAUVE_TAG: v2.5.0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.target.python }}
          cache: "pip"

      # --- CACHING SETUP ---
      - name: Cache Nuitka & ccache
        uses: actions/cache@v4
        with:
          path: |
            .build_cache
            ~/.ccache
            ~/Library/Caches/ccache
          key: ${{ runner.os }}-nuitka-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-

      # --- DEPENDENCIES ---
      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk tk-dev patchelf libfuse2 file ccache

      - name: Install system deps (macOS)
        if: startsWith(runner.os, 'macOS')
        run: brew install ccache

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -r requirements.txt
          pip install nuitka zstandard ordered-set

      # --- COMPILATION ---
      - name: Build CGCT (Nuitka OneFile)
        shell: bash
        env:
          NUITKA_CACHE_DIR: .build_cache
          CCACHE_DIR: ~/.ccache
        run: |
          mkdir -p .build_cache
          
          python -m nuitka --onefile \
            --windows-console-mode=disable \
            --enable-plugin=tk-inter \
            --include-package=gffutils \
            --noinclude-unittest-mode=allow \
            --assume-yes-for-downloads \
            --output-filename="${{ matrix.target.executable_name }}" \
            "${{ env.ENTRYPOINT }}"

      # --- PACKAGING (The "Release" Folder) ---
      - name: Prepare Release Folder
        shell: bash
        run: |
          # 1. Create the clean structure
          mkdir -p release/Tools
          
          # 2. Move Main Executable
          mv "${{ matrix.target.executable_name }}" release/
          
          # 3. Copy README
          cp "${{ matrix.target.readme_src }}" "release/readme.md"

          # 4. Copy Extras (Config/Dockerfile) - ONLY if requested (Windows/Mac)
          if [ "${{ matrix.target.include_extras }}" = "true" ]; then
             cp "config.txt" "release/config.txt"
             cp "Dockerfile" "release/Dockerfile"
          fi

          # 5. Copy Windows-specific Install Scripts
          if [ "${{ runner.os }}" = "Windows" ]; then
             cp "install-sibeliaz-wsl.bat" "release/install-sibeliaz-wsl.bat"
             cp "install-sibeliaz-wsl.sh" "release/install-sibeliaz-wsl.sh"
          fi

      # --- FETCH MAUVE (Into "Tools" folder) ---
      - name: Fetch progressiveMauve (macOS/Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          url="https://github.com/${MAUVE_REPO}/releases/download/${MAUVE_TAG}/${{ matrix.target.mauve_asset }}"
          curl -L --fail -o mauve.tar.gz "$url"
          
          mkdir -p mauve_extract
          tar -xzf mauve.tar.gz -C mauve_extract
          
          # Find binary and copy to Release/Tools/
          mauve_path="$(find mauve_extract -type f -name "${{ matrix.target.mauve_bin }}" -print -quit)"
          cp "$mauve_path" "release/Tools/${{ matrix.target.mauve_bin }}"
          
          # Permissions
          chmod +x "release/Tools/${{ matrix.target.mauve_bin }}"
          chmod +x "release/${{ matrix.target.executable_name }}"

      - name: Fetch progressiveMauve (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $url = "https://github.com/${env:MAUVE_REPO}/releases/download/${env:MAUVE_TAG}/${{ matrix.target.mauve_asset }}"
          Invoke-WebRequest -Uri $url -OutFile "mauve.zip"
          
          Expand-Archive -Path "mauve.zip" -DestinationPath "mauve_extract" -Force
          $mauve = Get-ChildItem -Path "mauve_extract" -Recurse -File -Filter "${{ matrix.target.mauve_bin }}" | Select-Object -First 1
          
          Copy-Item -Force $mauve.FullName "release\Tools\${{ matrix.target.mauve_bin }}"

      # --- UPLOAD ---
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ matrix.target.name }}
          path: release/
